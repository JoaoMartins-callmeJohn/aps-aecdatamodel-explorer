<html>

<head>
  <title>AEC CIM Explorer - BETA</title>
  <link href="https://unpkg.com/graphiql@1.10.0/graphiql.min.css" rel="stylesheet" />
  <link rel="icon" type="image/x-icon" href="https://cdn.autodesk.io/favicon.ico">
</head>

<body style="margin: 0">
  <div id="graphiql" style="height: calc(100vh - 33px)">
    Authenticating...
  </div>

  <script crossorigin src="https://unpkg.com/react/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/graphiql@1.10.0/graphiql.min.js"></script>

  <script>
    window.addEventListener("load", async () => {
      try {
        let url = new URL(window.location.href);
        let accessToken = url.searchParams.get("access_token");
        let clientId = url.searchParams.get("client_id");
        let clientSecret = url.searchParams.get("client_secret");

        if (!accessToken) {
          let params = "";
          if (clientId && clientSecret) {
            params = `?client_id=${clientId}&client_secret=${clientSecret}`;
          }
          let res = await fetch(`/oauth/token${params}`);
          if (!res.ok) throw "No access token";

          accessToken = await res.text();

          // Get a new token every 30 minutes
          setInterval(async () => {
            let res = await fetch(`/oauth/token?refresh=true`);
            if (res.ok) {
              accessToken = await res.text();
            } else {
              let res = await fetch("/oauth/url");
              url = await res.text();
              location.href = url;
            }
          }, 30 * 60 * 1000);
        }

        let defaultQuery = `# Welcome to the AEC CIM GraphQL Explorer - BETA

# Step 1: Pick a hub

query GetHubs {
  hubs {
    results {
      name
      id
    }
  }
}

# Step 2: Pick a project
# {
#  projects(hubId: "b.768cae14-76b3-4531-9030-25212dab4e48") {
#    results {
#      id
#      name
#    }
#  }
#}

`;

        function graphQLFetcher(graphQLParams, opts) {
          const { headers = {} } = opts;
          return fetch(
            "https://developer.api.autodesk.com/aeccloudinformationmodel/2022-11/graphql/v1/graph",
            {
              method: "post",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + accessToken,
                ...headers,
              },
              body: JSON.stringify(graphQLParams),
            }
          ).then((response) => response.json());
        }

        ReactDOM.render(
          React.createElement(GraphiQL, {
            fetcher: graphQLFetcher,
            query: defaultQuery,
            defaultQuery: { defaultQuery },
          }),
          document.getElementById("graphiql")
        );
      } catch {
        let res = await fetch("/oauth/url");
        url = await res.text();
        location.href = url;
      }
    });
  </script>
</body>

</html>