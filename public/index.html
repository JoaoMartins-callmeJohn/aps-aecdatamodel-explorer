<html>

<head>
  <title>AEC CIM Explorer - BETA</title>
  <link href="https://unpkg.com/graphiql@1.10.0/graphiql.min.css" rel="stylesheet" />
  <link rel="icon" type="image/x-icon" href="https://cdn.autodesk.io/favicon.ico">
</head>

<body style="margin: 0">
  <div id="graphiql" style="height: calc(100vh - 33px)">
    Authenticating...
  </div>

  <script crossorigin src="https://unpkg.com/react/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/graphiql@1.10.0/graphiql.min.js"></script>

  <script>
    window.addEventListener("load", async () => {
      try {
        let url = new URL(window.location.href);
        let accessToken = url.searchParams.get("access_token");
        let clientId = url.searchParams.get("client_id");
        let clientSecret = url.searchParams.get("client_secret");

        if (!accessToken) {
          let params = "";
          if (clientId && clientSecret) {
            params = `?client_id=${clientId}&client_secret=${clientSecret}`;
          }
          let res = await fetch(`/oauth/token${params}`);
          if (!res.ok) throw "No access token";

          accessToken = await res.text();

          // Get a new token every 30 minutes
          setInterval(async () => {
            let res = await fetch(`/oauth/token?refresh=true`);
            if (res.ok) {
              accessToken = await res.text();
            } else {
              let res = await fetch("/oauth/url");
              url = await res.text();
              location.href = url;
            }
          }, 30 * 60 * 1000);
        }

        let defaultQuery = `# Welcome to the AEC CIM GraphQL Explorer - BETA
# These sample queries are from the Getting Started tutorial

# Step 1: Pick a hub
query GetHubs {
  hubs {
    results {
      name
      id
    }
  }
}

# Step 2: Pick a project
query GetProjects {
  projects(hubId: "b.768cae14-76b3-4531-9030-25212dab4e48") {
    results {
      id
      name
    }
  }
}

# Step 3: Navigate to folders and designs with in a project
query GetDesigns {
  project(
    hubId: "b.768cae14-76b3-4531-9030-25212dab4e48"
    projectId: "b.f609fbf7-7959-4832-a379-84028c470d0c"
  ) {
    id
    name
    folders {
      results {
        id
        name
        items {
          results {
            id
            name
            __typename
            ... on BasicFile {
              designId
              name
            }
          }
        }
      }
    }
  }
}

# Step 4: Get design entities with in a design using properties filter
query GetEntities {
  designEntities(
    filter: {designId: "fbb418e4-d663-36fe-bf87-7c555acc4983", propertyFilter: {name: "Level", value: "Level 2"}}
  ) {
    pagination {
      cursor
      limit
    }
    results {
      references {
        results {
          id
          propertyGroups {
            results {
              properties {
                results {
                  name
                  value
                }
              }
            }
          }
        }
      }
    }
  }
}

`;

        function graphQLFetcher(graphQLParams, opts) {
          const { headers = {} } = opts;
          return fetch(
            "https://developer.api.autodesk.com/aeccloudinformationmodel/2022-11/graphql",
            {
              method: "post",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + accessToken,
                ...headers,
              },
              body: JSON.stringify(graphQLParams),
            }
          ).then((response) => response.json());
        }

        ReactDOM.render(
          React.createElement(GraphiQL, {
            fetcher: graphQLFetcher,
            query: defaultQuery,
            defaultQuery: { defaultQuery },
          }),
          document.getElementById("graphiql")
        );
      } catch {
        let res = await fetch("/oauth/url");
        url = await res.text();
        location.href = url;
      }
    });
  </script>
</body>

</html>